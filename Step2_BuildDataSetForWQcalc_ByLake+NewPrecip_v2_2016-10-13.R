# Build data set by lake for input to WQ calculation
# Note this program omits the separated dissolved and sediment P loads (lines 145-152 of dataset)
# SRC 2016-02-27

rm(list = ls())
graphics.off()

# Load full set of factorial data generated by Step 1 program
# In File names 2 characters are LU and second two characters are climate
# e.g. AINW is LU variables of AI combined with climate of NW
#XC = rbind(X.AIAI,X.AIAR,X.AICC,X.AINW,
#           X.ARAI,X.ARAR,X.ARCC,X.ARNW,
#           X.CCAI,X.CCAR,X.CCCC,X.CCNW,
#           X.NWAI,X.NWAR,X.NWCC,X.NWNW)

# Save the composite dataframe for later analysis
# save(XC,file='Factorial_All_V2.Rdata')
load(file='Factorial_All_V2.Rdata')

# Contributing areas to direct drainage load in each watershed, ha
DDarea = c(492.4,119.2,125.0,147.7)*100

# Climate Predictors
# All climate predictors are same for all lakes in a give year & scenario combo
# Note this skips over the precip indicators based on "number of days above threshold"
Precip = cbind(XC[1:912,2:4],XC[1:912,8:10],XC[1:912,14:16],XC[1:912,162:171])
# Make intuitive column names
colnames(Precip) = c('AnnPPT','RainSpring','MaxPPT',
                     'MaxNoPPT','MeanDry','MaxDry',
                     'GDD','GSlen','SpringOn',
                     'D1pct90','D2pct90','D3pct90','D5pct90','D7pct90',
                     'D1pct75','D2pct75','D3pct75','D5pct75','D7pct75')

# Build Mendota Data Set  *************************************************
Year = XC$X1
NY = length(Year)
LakeID = rep(1,NY) # 1 Mendota through 4 Kegonsa
# Extract codes for Land Use /Management drivers and Climate drivers
# Note these are the same for all 4 lakes
# 1 = AI, 2 = AR, 3 = CC, 4 = NW
LULM = XC$Luse
CLIM = XC$Clim
# LC predictors
LC = XC[,17:24]
# Land management predictors
LM = XC[,49:60]
# Snow predictors
Snow = XC[,97:99]
# Runoff predictors
Runoff = XC[,109:112]
# P related predictors
SoilP = XC[,125]
Pyield = XC[,129:131]
DDL = XC$X141
DDLareal = XC$X141/DDarea[1]  # Direct drainage load kg/(ha*y)
# Bind all variables into single matrix preserving Missy & Xi sequence adding new variables at end
All.Me = cbind(Year,LC,LM,Snow,Runoff,SoilP,Pyield,DDL,DDLareal,LakeID,LULM,CLIM)
# Clear variables that are specific to Mendota
rm(LC,LM,Snow,Runoff,SoilP,Pyield,DDL,DDLareal,LakeID)

# Build Monona Data Set *************************************************************
LakeID = rep(2,NY) # 1 Mendota through 4 Kegonsa
# LC predictors
LC = XC[,25:32]
# Land management predictors
LM = XC[,61:72]
# Snow predictors
Snow = XC[,100:102]
# Runoff predictors
Runoff = XC[,113:116]
# P related predictors
SoilP = XC[,126]
Pyield = XC[,132:134]
DDL = XC$X142
DDLareal = XC$X142/DDarea[2]  # Direct drainage load kg/(ha*y)
# Bind all variables into single matrix preserving Missy & Xi sequence adding new variables at end
All.Mo = cbind(Year,LC,LM,Snow,Runoff,SoilP,Pyield,DDL,DDLareal,LakeID,LULM,CLIM)
# Clear variables that are specific to Monona
rm(LC,LM,Snow,Runoff,SoilP,Pyield,DDL,DDLareal,LakeID)

# Build Waubesa Data Set *************************************************************
LakeID = rep(3,NY) # 1 Mendota through 4 Kegonsa
# LC predictors
LC = XC[,33:40]
# Land management predictors
LM = XC[,73:84]
# Snow predictors
Snow = XC[,103:105]
# Runoff predictors
Runoff = XC[,117:120]
# P related predictors
SoilP = XC[,127]
Pyield = XC[,135:137]
DDL = XC$X143
DDLareal = XC$X143/DDarea[3]  # Direct drainage load kg/(ha*y)
# Bind all variables into single matrix preserving Missy & Xi sequence adding new variables at end
All.Wa = cbind(Year,LC,LM,Snow,Runoff,SoilP,Pyield,DDL,DDLareal,LakeID,LULM,CLIM)
# Clear variables that are specific to Waubesa
rm(LC,LM,Snow,Runoff,SoilP,Pyield,DDL,DDLareal,LakeID)

# Build Kegonsa Data Set *************************************************************
LakeID = rep(4,NY) # 1 Mendota through 4 Kegonsa
# LC predictors
LC = XC[,41:48]
# Land management predictors
LM = XC[,85:96]
# Snow predictors
Snow = XC[,106:108]
# Runoff predictors
Runoff = XC[,121:124]
# P related predictors
SoilP = XC[,128]
Pyield = XC[,138:140]
DDL = XC$X144
DDLareal = XC$X144/DDarea[4]  # Direct drainage load kg/(ha*y)
# Bind all variables into single matrix preserving Missy & Xi sequence adding new variables at end
All.Ke = cbind(Year,LC,LM,Snow,Runoff,SoilP,Pyield,DDL,DDLareal,LakeID,LULM,CLIM)
# Clear variables that are specific to Kegonsa
rm(LC,LM,Snow,Runoff,SoilP,Pyield,DDL,DDLareal,LakeID)

# Stack all of the lakes into the final data matrix
# For consistency, all column names converted to the Mendota column names
names(All.Mo) = names(All.Me)
names(All.Wa) = names(All.Me)
names(All.Ke) = names(All.Me)
AllVars = rbind(All.Me,All.Mo,All.Wa,All.Ke)

# Make some useful submatrices
LandUse = AllVars[,2:9]   # 17-24 for Mendota in original file
LandMgmt = AllVars[,10:21] # 49-60 for Mendota in original file
Snow=AllVars[,22:24] # 97-99 for Mendota in original file
Runoff=AllVars[,25:28] # 109-112 for Mendota in original file
SoilP = AllVars[,29] # 125 for Mendota in original file
Pyield = AllVars[,30:32]  # 129-131 for Mendota in original file
DDL = AllVars[,33]  # 141 for Mendota in original file
DDLareal = AllVars$DDLareal
LakeID = AllVars$LakeID

# Stack Precip 4 times to account for all lakes
Precip4 = rbind(Precip,Precip,Precip,Precip)

# Try some test plots
lDDLar = log(DDLareal)

windows()
par(mfrow=c(2,2),cex.axis=1.4,cex.lab=1.4,font.lab=2,font.axis=2,cex.main=1.4,font.main=1,
    mar=c(4, 4.2, 2.5, 2) + 0.1)
plot(LandMgmt[,1],lDDLar,type='p',col='darkred',pch=19,cex=0.5,
     xlab='Manure',ylab='Log Areal Load')
plot(LandMgmt[,2],lDDLar,type='p',col='darkred',pch=19,cex=0.5,
     xlab='Fertilizer',ylab='Log Areal Load')
plot(Precip4[,1],lDDLar,type='p',col='blue',pch=19,cex=0.5,
     xlab='AnnPPT',ylab='Log Areal Load')
plot(LandUse[,2],lDDLar,type='p',col='green',pch=19,cex=0.5,
     xlab='Corn',ylab='Log Areal Load')

# Save data sets
# AllVars is all data arranged by lake, scenario and year 
# The lake code is 1 = Mendota, 2 = Monona, 3 = Waubesa, 4 = Kegonsa
# The driver scenario code is 1 = AI, 2 = AR, 3 = CC, 4 = NW
# For definitions of the columns see the code for Mendota in Step 2
#
# Useful submatrices are as follows:
# LandUse is the land use variables only
# LandMgmt is the P management variables only (Manure + Fert are NOT areal)
# Snow is the snow cover variables only
# Runoff is the water runoff variables only
# SoilP is soil P content
# Pyield is the P runoff variables
# DDL is direct drainage load
# DDLareal is direct drainage load per ha
# LakeID is lake ID number (1 for Mendota through 4 for Kegonsa)
# Precip is the precip by scenario and year for the entire Yahara (not by lake)
# Precip4 is the precip matrix stacked 4X to account for all 4 lakes
# DDarea is the area in ha contributing to direct drainage
save(AllVars,LandUse,LandMgmt,Snow,Runoff,SoilP,Pyield,DDL,DDLareal,LakeID,Precip,Precip4,DDarea,file='AllVarsByLake.Rdata')

